<p id="notice"><%= notice %></p>

<p>
  <strong>Room name:</strong>
  <%= @room.room_name %>
</p>

<!--<%= link_to 'Edit', edit_room_path(@room) %> |-->
<%= link_to 'Back', rooms_path %>

	<!--// Header //-->
	<div id="headerContainer" class="container">
	<div class="row">
		<div class="col-sm-3">
			<h1>DONNOのロゴ</h1>
		</div>
		<div class="col-sm-9">
			<h2>ルーム名</h2>
		</div>
	</div>
	</div>

	<div id="mainContainer" class="container">
		<div class="row">


			<!-- ボタンエリア -->
			<div id="button_area" class="text-center">
				<input type="checkbox"  id ="donno" data-toggle="toggle" data-on="わからん" data-off="わかってる">
				<button id="wow">へぇ〜</button>
			</div>
			<div id="mainDiv" class="col-sm-9">

				<!--// Submit Area //-->
				<div>
						<div class="form-inline">
							<div class="form-group">
								<input type="text" id="MpInput" class="form-control" placeholder="授業にコメントしよう！" size="80" maxlength="140">
							</div>
							<div class="form-group">
								<input type="button" id="micropost_submit" value="送信" class="btn btn-success">
							</div>
						</div>
				</div>

				<!--// Micro Posts Area //-->
				<div id="microPostDiv">
					<!-- 表示欄 -->
					<ul id="micropost_ul">
					</ul>
				</div>
			</div>

			<!--// Donno Graph Area //-->
			<div id="graphDiv" class="col-sm-3">
				<div class="graphBars" id="graphDonnoBar">
				</div>
				<div class="graphBars" id="graphWowBar">
				</div>
			</div>
		</div>
	</div>

<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.0/css/bootstrap-toggle.min.css" rel="stylesheet">
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.0/js/bootstrap-toggle.min.js"></script>
<script>
var last = 0;
var get_flag = false;
var donno = false;
	/*
	console.log("view");
	$("#install").click(function(){
	console.log("view2");
	});*/

$(function(){
	
	if(get_flag == false){
		loadRoom();
		get_flag = true;
	}
});

function loadRoom(){
$("#micropost_ul").ready(function(){
	//console.log("Hello World!");
	//alert("テスト");
	//console.log("<%=@room.id%>");
	//console.log(last);

	if($("#donno:checked").val()){
		donno = true;
	}else{
		donno = false;
	}
	console.log(donno);
	$.ajax({
		//url:"http://localhost:3000/rooms/1.json?uuid=6fc32589-bd1f-4595-ab6f-981fa861a10c&last=98&donno=true",

		url:location.protocol+"//" + location.host +"/rooms/"+ <%=@room.id%> + ".json?uuid=XXX&donno="+donno+"&last="+last,
		type:'get',
		cache: false,
		dataType: 'json'
	}).always(function(data) {
		//console.log(data);
		var microposts = data.microposts
		last += microposts.length;
		if(microposts.length >= 1){
			for(i=0; i<microposts.length; i++){
				$("#micropost_ul").append("<li>"+microposts[i].content+"</li>");
			}
		}
		var targetY = $("#micropost_ul")[0].scrollHeight;
		console.log(targetY)
		$("#micropost_ul").scrollTop(0);
		//$("html, body").animate({scrollTop:targetY});

		$("#graphDonnoBar").css({"height" : parseFloat(data.donno)*100+"%"});
		var wow_rate = parseFloat(data.wow)>1 ? 100 : parseFloat(data.wow)*100
		$("#graphWowBar").css({"height" : wow_rate+"%"});
		console.log(parseFloat(data.donno)*100+"%");
		console.log(parseFloat(data.wow)*100+"%");
		setTimeout("loadRoom()", 3000);
	});
});
}

$("#micropost_submit").click(function(){
	var content = $("#MpInput").val();
	$.ajax({
		url: location.protocol+"//" + location.host +"/microposts.json",
		type:'post',
		  headers: {
		    'X-PINGOTHER': 'pingpong'
		  },
		cache: false,
		dataType: 'json',
		data:{
			"micropost[uuid]": "6fc32589-bd1f-4595-ab6f-981fa861a10c",
			"micropost[content]": content,
			"micropost[room_id]": "<%=@room.id%>"
		}
	}).done(function(data) {
		$("#MpInput").val("");
		console.log(data);
	});
});


$("#wow").click(function(){
	//var content = $("#MpInput").val();
	$.ajax({
		url:location.protocol+"//" + location.host +"/users/XXX.json",//uuid
		type:'patch',
		cache: false,
		dataType: 'json',
		data:{
			"user[wow]": "4",
			//"user[uuid]":"XXX",
			"user[donno]":"true"
		}
	}).done(function(data) {
		console.log(data);
	});
});

</script>
